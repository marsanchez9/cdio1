import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.linear_model import LinearRegression
from sklearn.preprocessing import PolynomialFeatures
from sklearn.metrics import mean_squared_error, r2_score

print("=== AN√ÅLISIS COMPLETO: RADIACI√ìN SOLAR Y TEMPERATURA EN BARCELONA ===")
print("=" * 70)

# =============================================================================
# CARGA Y EXPLORACI√ìN DE DATOS
# =============================================================================
print("\nüìä CARGANDO DATOS...")

# NOTA: Cambia por el nombre EXACTO de tu archivo CSV
df = pd.read_csv('valores1.csv', skiprows=11)

# Crear d√≠a del a√±o para Parte 3
df['day_of_year'] = range(1, len(df) + 1)

print("Primeras filas del dataset:")
print(df[['ALLSKY_SFC_SW_DWN', 'T2M', 'RH2M', 'day_of_year']].head())

# =============================================================================
# PARTE 1: REGRESI√ìN LINEAL SIMPLE
# =============================================================================
print("\n" + "="*50)
print("PARTE 1: REGRESI√ìN LINEAL SIMPLE")
print("Radiaci√≥n Solar vs Temperatura")
print("="*50)

# Preparar datos
X_simple = df[['ALLSKY_SFC_SW_DWN']]
y = df['T2M']

# Entrenar modelo simple
model_simple = LinearRegression()
model_simple.fit(X_simple, y)
y_pred_simple = model_simple.predict(X_simple)

# Resultados
r2_simple = model_simple.score(X_simple, y)
rmse_simple = np.sqrt(mean_squared_error(y, y_pred_simple))

print(f"Intercepto (b‚ÇÄ): {model_simple.intercept_:.2f}¬∞C")
print(f"Pendiente (b‚ÇÅ): {model_simple.coef_[0]:.4f}¬∞C por kWh/m¬≤/d√≠a")
print(f"R¬≤: {r2_simple:.4f} ({r2_simple*100:.1f}% de variaci√≥n explicada)")
print(f"RMSE: {rmse_simple:.2f}¬∞C")

# =============================================================================
# PARTE 2: REGRESI√ìN LINEAL M√öLTIPLE
# =============================================================================
print("\n" + "="*50)
print("PARTE 2: REGRESI√ìN LINEAL M√öLTIPLE") 
print("Radiaci√≥n Solar + Humedad vs Temperatura")
print("="*50)

# Preparar datos m√∫ltiples
X_multi = df[['ALLSKY_SFC_SW_DWN', 'RH2M']]

# Entrenar modelo m√∫ltiple
model_multi = LinearRegression()
model_multi.fit(X_multi, y)
y_pred_multi = model_multi.predict(X_multi)

# Resultados
r2_multi = model_multi.score(X_multi, y)
rmse_multi = np.sqrt(mean_squared_error(y, y_pred_multi))

print(f"Intercepto (b‚ÇÄ): {model_multi.intercept_:.2f}¬∞C")
print(f"Coeficientes (b‚ÇÅ, b‚ÇÇ): [{model_multi.coef_[0]:.4f}, {model_multi.coef_[1]:.4f}]")
print(f"R¬≤: {r2_multi:.4f} ({r2_multi*100:.1f}% de variaci√≥n explicada)")
print(f"RMSE: {rmse_multi:.2f}¬∞C")

# Comparaci√≥n
print(f"\nComparaci√≥n con modelo simple:")
print(f"Mejora en R¬≤: {r2_multi - r2_simple:.4f}")

# =============================================================================
# PARTE 3: REGRESI√ìN POLIN√ìMICA
# =============================================================================
print("\n" + "="*50)
print("PARTE 3: REGRESI√ìN POLIN√ìMICA")
print("Estacionalidad de la Temperatura")
print("="*50)

# Probar diferentes grados
X_poly = df[['day_of_year']]
resultados_poly = []

for grado in [1, 2, 4]:
    poly = PolynomialFeatures(degree=grado)
    X_poly_trans = poly.fit_transform(X_poly)
    
    model_poly = LinearRegression()
    model_poly.fit(X_poly_trans, y)
    y_pred_poly = model_poly.predict(X_poly_trans)
    
    r2 = r2_score(y, y_pred_poly)
    rmse = np.sqrt(mean_squared_error(y, y_pred_poly))
    
    resultados_poly.append({
        'grado': grado, 
        'model': model_poly, 
        'poly': poly,
        'y_pred': y_pred_poly,
        'r2': r2,
        'rmse': rmse
    })
    
    print(f"Grado {grado}: R¬≤ = {r2:.4f}, RMSE = {rmse:.2f}¬∞C")

mejor_poly = max(resultados_poly, key=lambda x: x['r2'])
print(f"\n‚úÖ MEJOR MODELO POLIN√ìMICO: Grado {mejor_poly['grado']}")

# =============================================================================
# GR√ÅFICAS COMBINADAS
# =============================================================================
print("\n" + "="*50)
print("GENERANDO GR√ÅFICAS COMBINADAS...")
print("="*50)

# Crear figura con 4 subgr√°ficas
fig, axes = plt.subplots(2, 2, figsize=(15, 12))

# ===========================================
# Gr√°fica 1: Regresi√≥n Simple (Arriba Izquierda)
# ===========================================
axes[0,0].scatter(X_simple, y, alpha=0.6, color='blue', s=30, label='Datos observados')
axes[0,0].plot(X_simple, y_pred_simple, color='red', linewidth=2, label='Recta de regresi√≥n')
axes[0,0].set_xlabel('Radiaci√≥n Solar (kWh/m¬≤/d√≠a)')
axes[0,0].set_ylabel('Temperatura (¬∞C)')
axes[0,0].set_title(f'PARTE 1: Regresi√≥n Lineal Simple\nR¬≤ = {r2_simple:.3f}, RMSE = {rmse_simple:.2f}¬∞C')
axes[0,0].legend()
axes[0,0].grid(True, alpha=0.3)

# ===========================================
# Gr√°fica 2: Comparaci√≥n M√∫ltiple (Arriba Derecha)
# ===========================================
# Scatter de radiaci√≥n vs temperatura
scatter = axes[0,1].scatter(df['ALLSKY_SFC_SW_DWN'], df['T2M'], c=df['RH2M'], 
                           cmap='viridis', alpha=0.7, s=30)
axes[0,1].set_xlabel('Radiaci√≥n Solar (kWh/m¬≤/d√≠a)')
axes[0,1].set_ylabel('Temperatura (¬∞C)')
axes[0,1].set_title(f'PARTE 2: Regresi√≥n M√∫ltiple\nR¬≤ = {r2_multi:.3f}, RMSE = {rmse_multi:.2f}¬∞C')
plt.colorbar(scatter, ax=axes[0,1], label='Humedad Relativa (%)')
axes[0,1].grid(True, alpha=0.3)

# ===========================================
# Gr√°fica 3: Regresi√≥n Polin√≥mica (Abajo Izquierda)
# ===========================================
colors_poly = ['red', 'blue', 'green']
for i, resultado in enumerate(resultados_poly):
    axes[1,0].plot(X_poly, resultado['y_pred'], 
                   color=colors_poly[i], 
                   linewidth=2, 
                   label=f'Grado {resultado["grado"]} (R¬≤ = {resultado["r2"]:.3f})')

axes[1,0].scatter(X_poly, y, alpha=0.3, color='black', s=10, label='Datos observados')
axes[1,0].set_xlabel('D√≠a del A√±o')
axes[1,0].set_ylabel('Temperatura (¬∞C)')
axes[1,0].set_title('PARTE 3: Regresi√≥n Polin√≥mica\nEstacionalidad de la Temperatura')
axes[1,0].legend()
axes[1,0].grid(True, alpha=0.3)

# ===========================================
# Gr√°fica 4: Heatmap de Correlaciones (Abajo Derecha)
# ===========================================
correlation_matrix = df[['ALLSKY_SFC_SW_DWN', 'T2M', 'RH2M']].corr()
sns.heatmap(correlation_matrix, annot=True, cmap='coolwarm', center=0,
            vmin=-1, vmax=1, square=True, ax=axes[1,1])
axes[1,1].set_title('Matriz de Correlaci√≥n')

# Ajustar layout y guardar
plt.tight_layout()
plt.savefig('analisis_completo_barcelona.png', dpi=300, bbox_inches='tight')
print("‚úÖ Gr√°fica completa guardada como 'analisis_completo_barcelona.png'")

# =============================================================================
# RESUMEN FINAL
# =============================================================================
print("\n" + "="*70)
print("üìà RESUMEN FINAL DEL AN√ÅLISIS")
print("="*70)

print(f"\nPARTE 1 - Regresi√≥n Simple:")
print(f"  ‚Ä¢ Cada kWh/m¬≤/d√≠a de radiaci√≥n aumenta la temperatura en {model_simple.coef_[0]:.4f}¬∞C")
print(f"  ‚Ä¢ El {r2_simple*100:.1f}% de la variaci√≥n en temperatura se explica por la radiaci√≥n solar")

print(f"\nPARTE 2 - Regresi√≥n M√∫ltiple:")
print(f"  ‚Ä¢ Radiaci√≥n: {model_multi.coef_[0]:.4f}¬∞C por kWh/m¬≤/d√≠a")
print(f"  ‚Ä¢ Humedad: {model_multi.coef_[1]:.4f}¬∞C por % de humedad")
print(f"  ‚Ä¢ Mejora al a√±adir humedad: {r2_multi - r2_simple:.4f} en R¬≤")

print(f"\nPARTE 3 - Regresi√≥n Polin√≥mica:")
print(f"  ‚Ä¢ Mejor modelo: Grado {mejor_poly['grado']} (R¬≤ = {mejor_poly['r2']:.4f})")
print(f"  ‚Ä¢ Captura la estacionalidad anual de la temperatura")

print(f"\nCORRELACIONES:")
print(f"  ‚Ä¢ Radiaci√≥n-Temperatura: {correlation_matrix.loc['ALLSKY_SFC_SW_DWN', 'T2M']:.3f}")
print(f"  ‚Ä¢ Radiaci√≥n-Humedad: {correlation_matrix.loc['ALLSKY_SFC_SW_DWN', 'RH2M']:.3f}")
print(f"  ‚Ä¢ Temperatura-Humedad: {correlation_matrix.loc['T2M', 'RH2M']:.3f}")

print("\n" + "="*70)
print("‚úÖ AN√ÅLISIS COMPLETADO")
print("üìä Gr√°fica guardada: 'analisis_completo_barcelona.png'")
print("="*70)
